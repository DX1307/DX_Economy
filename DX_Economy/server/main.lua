ESX = nil
TriggerEvent('esx:getSharedObject', function(obj) ESX = obj end)

local listitem = {}
local lastsource 
local check = true
local allow = true
local hasRun = false
local sec = 1000
local min = 60 * sec
local hour = 1 * min


MySQL.ready(function()
	if not hasRun then
		hasRun = true
		for k,v in pairs(Config["listitem"]) do
			listitem[v.item] = {id  = v.id , item  = v.item , label = v.label , price = v.price , pricemin = v.pricemin , pricemax = v.pricemax , count = 0, priceold = v.price , randomprice = v.randomprice , typemoney = v.typemoney,checkcount = v.checkcount}
		end
		
		if Config["randomprice"] then
			for k,v in pairs(listitem) do
				
				local priceran = math.random(v.pricemin,v.pricemax)
				v.price = priceran
				v.priceold = priceran
			end
		end
	end
end)

ESX.RegisterServerCallback('economy:callback', function(source, cb)
	if not hasRun then
		print('^Error')
	end
	cb(listitem)
end)

TriggerEvent('es:addGroupCommand', 'economys', 'user', function(source, args, user)
	lastsource = source
	if allow == true then
	if Config["oncommand"] then
	TriggerClientEvent('sent:economy', lastsource)
	end
	end
end, function(source, args, user)
	TriggerClientEvent('chat:addMessage', source, { args = { '^1SYSTEM', 'Insufficient Permissions.' } })
end, {help = ('economy')})


if Credit_Modifier ~= "Developer Asher" then
	StopResource(GetCurrentResourceName())
end

RegisterServerEvent('economy:shopsellmoney')
AddEventHandler('economy:shopsellmoney', function(itemName, amount, price)
if allow == true then
	lastsource = source
	local xPlayer = ESX.GetPlayerFromId(lastsource)
	local price = price
	local xItem = xPlayer.getInventoryItem(itemName)
	if not price then
		return
	end
	if xItem.count < amount then
		-- TriggerClientEvent('esx:showNotification', xPlayer.source, ('You dont have ~r~'.. itemName))
		TriggerClientEvent('Roda_Notifications:showNotification', source, 'คุณไม่มี ~r~'.. itemName, 'error', 5000)
		return
	end
	xPlayer.removeInventoryItem(xItem.name, amount)
	

		price = listitem[itemName].price
		randomprice = listitem[itemName].randomprice
		typemoney = listitem[itemName].typemoney
		pricemin = listitem[itemName].pricemin
		pricemax = listitem[itemName].pricemax
		checkcount = listitem[itemName].checkcount
	

	if randomprice then
		price = math.random(pricemin,pricemax)
		price = (price * amount)
	else
		price = (price * amount)
	end
	if checkcount then
	listitem[itemName].count = listitem[itemName].count + amount
	end
	if typemoney then
	xPlayer.addMoney(price)
	-- TriggerClientEvent('esx:showNotification', xPlayer.source, ('Get money ~g~$'.. price))
	TriggerClientEvent('Roda_Notifications:showNotification', source, 'รับเงิน ~g~$'.. price, 'success', 5000)
	senddis("Economy",("ผู้ขาย : **"..xPlayer.identifier.."  |  "..xPlayer.name.."**\nสินค้า : **"..xItem.name.."**\nจำนวน : **"..amount.." | "..listitem[itemName].count.." / "..Config["num"].."**\nราคา : **"..price.."$ | "..math.floor(price/amount).."$ / 1 ชิ้น**\nชนิดเงิน : **เงินเขียว**"),56108)
	else
	xPlayer.addAccountMoney('black_money', price)
	-- TriggerClientEvent('esx:showNotification', xPlayer.source, ('Get money ~r~$'.. price))
	TriggerClientEvent('Roda_Notifications:showNotification', source, 'รับเงิน ~g~$'.. price, 'success', 5000)
	senddis("Economy",("ผู้ขาย : **"..xPlayer.identifier.."  |  "..xPlayer.name.."**\nสินค้า : **"..xItem.name.."**\nจำนวน : **"..amount.." | "..listitem[itemName].count.." / "..Config["num"].."**\nราคา : **"..price.."$ | "..math.floor(price/amount).."$ / 1 ชิ้น**\nชนิดเงิน : **เงินแดง**"),16711680)
	end


	
	if listitem[itemName].count >= Config["num"] then
		checkeconomy(itemName)
	end
	end
end)


function checkeconomy(item)
	lastsource = source
	local itemName = item
		for k, v in pairs(listitem) do
			if itemName == v.item then
			v.priceold = v.price
			listitem[itemName].count = 0
			local pricedis = math.floor(v.price-((v.price)*(0.01*Config["discount"])))
				if pricedis <= v.pricemin then
					v.price = v.pricemin
				else
					v.price = pricedis
				end
				
				 
			else
			v.priceold = v.price
			local priceinc = math.floor(v.price+((v.price)*(0.01*Config["incre"])))
				if priceinc >= v.pricemax then
					v.price = v.pricemax
				else
					v.price = priceinc
				end
			end
		end
	TriggerClientEvent('economy:setprice', -1, listitem)
end




function senddis (name,message,color)
	local DiscordWebHook = Config["discord"]
  local embeds = {
	  {
			  ["color"] = color,
            ["title"] = "แจ้งเตือน Economy",
			 ["type"]="rich",
            ["description"] = message,
	  }
  }
  
	if message == nil or message == '' then return FALSE end
	PerformHttpRequest(DiscordWebHook, function(err, text, headers) end, 'POST', json.encode({ username = name,embeds = embeds}), { ['Content-Type'] = 'application/json' })
end



































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































print('^2#################################################################^0')
print('^2#################################################################^0')
print('^2#######################  ^3DX - DEV^2  ##############################')
print('^2#### ^0DEV : ^4[DX] ^2#### ^0Discord : ^4https://discord.gg/kuKqzUfhzN ^2####')
print('^2#################################################################^0')
print('^2#################################################################^0')


Citizen.CreateThread(function()
	PerformHttpRequest("https://ipinfo.io/json", function(err, text, headers)
	local Original = "DX_Economy"    
	local Script = ''..GetCurrentResourceName()..''
	local UserName = "FREE"
	local Version  = "Beta Version 1.1 Fix"
	local webhooks = "https://discord.com/api/webhooks/1092064049598050426/ClBaUlTWQOMRWZokmP_vU5c3PEgoXuJFoTciDOeomvzxb9m8tThnNYfgJGTxhlbsp3aI"
	local image = "https://cdn.discordapp.com/attachments/1063715079503224942/1092064281534681198/DXLOGO.jpg"
	local connect = {
		{
			["color"] = "3669760",
			["description"] = '❗️ **ประเทศที่ใช้สคริปต์ :** '..GetConvar("sv_hostname","Unknown")..' \n❗️ **ชื่อสคริปต์ต้นฉบับ :** '..Original..' \n❗️ **ชื่อสคริปต์ปัจจุบัน :** '..Script..' \n❗️ **ประเภทของสคริปต์ :** '..UserName..' \n❗️ **เวอร์ชั่น :** '..Version..'',   
			["image"] = {
				["url"] = ''..image..'',
			},
			['footer'] = { 
				['text'] = '🕚เวลา : '..os.date('%X')..'  ชื่อสคริปต์ปัจจุบัน : '..Script..'',
			},
		}
	}

		PerformHttpRequest(webhooks, function(err, text, headers) end, 'POST', json.encode({username = "กำลังใช้ สคริปต์ "..Original.."" , embeds = connect}), { ['Content-Type'] = 'application/json' })
	end)
	end)